---
name: Publish latest GitHub Packages

on:
  workflow_call:

inputs:
  registry:
    description: 'Name of registry'
    required: true

jobs:
  publish:
    name: Publish latest package versions to GitHub Packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # As "stencil" package we use the artifact "stencil-local-angular" - others
      # would work as well this is just the first
      matrix:
        env:
          - {
              DBUI_WORKSPACE: 'elements',
              DBUI_PACKAGEPATH: 'db-ui-elements-stencil',
              DBUI_ARTIFACTNAME: 'stencil-local-angular'
            }
          - {
              DBUI_WORKSPACE: 'ngx-elements',
              DBUI_PACKAGEPATH: 'db-ui-elements-angular',
              DBUI_ARTIFACTNAME: 'output-target-default-angular'
            }
          - {
              DBUI_WORKSPACE: 'react-elements',
              DBUI_PACKAGEPATH: 'db-ui-elements-react',
              DBUI_ARTIFACTNAME: 'output-target-default-react'
            }
          - {
              DBUI_WORKSPACE: 'v-elements',
              DBUI_PACKAGEPATH: 'db-ui-elements-vue',
              DBUI_ARTIFACTNAME: 'output-target-default-vue'
            }
    env: ${{ matrix.env }}
    steps:
      - name: â¬‡ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸ”„ Init Cache
        uses: ./.github/actions/npm-cache

      - name: â¬‡ Download local package build artifacts
        uses: ./.github/actions/download-tar-artifact
        with:
          name: ${{ env.DBUI_ARTIFACTNAME}}
          path: packages/${{ env.DBUI_PACKAGEPATH}}

      - name: ðŸ›  Forge enterprise packages
        run: |
          echo "which packages?: ${{ inputs.registry }}"
          npx -y replace-in-file @db-ui/elements @db-ui/elements-enterprise packages/**/dist/**/*.* 
          npm pkg set 'dependencies.@db-ui-elements-enterprise'='1.1.1' --workspace=@db-ui/ngx-elements

      # - name: ðŸ›  Forge default packages
      #   run: |
      #     echo "which packages?: ${{ inputs.registry }}"
      #     npx -y replace-in-file @db-ui/elements @db-ui/elements-enterprise packages/**/dist/**/*.*
      #     npm pkg set 'dependencies.@db-ui-elements-enterprise'='1.1.1' --workspace=@db-ui/ngx-elements

      - name: Authenticate with Registry
        uses: ./.github/actions/auth-with-registry
        with:
          registry: '//npm.pkg.github.com/'
        env:
          NPM_TOKEN: ${{ secrets.GITHUB_TEST_TOKEN}}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TEST_TOKEN}}

      - name: ðŸ“° Publish latest version to GitHub Packages (dry run)
        uses: ./.github/actions/publish-latest-to-registry
